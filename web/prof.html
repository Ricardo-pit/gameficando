<!doctype html><html lang="pt-br"><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gameficando ‚Ä¢ Professor</title>
<style>body{font-family:system-ui,Arial;margin:20px} .card{border:1px solid #ddd;border-radius:12px;padding:12px;max-width:720px}
label{font-size:12px;color:#666} input,select,button{padding:8px;font-size:14px} input,select{width:100%} table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #eee;padding:6px;text-align:left}</style>
<h1>Gameficando ‚Ä¢ Professor</h1>

<div class="card">
  <h3>Conex√£o & Login</h3>
  <label>SUPABASE_URL</label><input id="url" placeholder="https://xxxx.supabase.co">
  <label>ANON KEY</label><input id="anon" placeholder="eyJ...">
  <label>Email</label><input id="email" placeholder="prof@escola.com">
  <label>Senha</label><input id="pwd" type="password" placeholder="********">
  <div style="margin-top:8px"><button id="login">Entrar</button> <span id="me" style="margin-left:8px;color:#666"></span></div>
</div>

<div class="card" style="margin-top:12px">
  <h3>Minhas turmas</h3>
  <label>Selecione</label>
  <select id="turmas"></select>
  <div style="display:flex;gap:8px;margin-top:8px">
    <button id="loadAlunos">Carregar Alunos</button>
    <button id="loadGrupos">Carregar Grupos</button>
  </div>

  <h4>Alunos</h4>
  <table id="alunos"><thead><tr><th>ID</th><th>Nome</th></tr></thead><tbody></tbody></table>

  <h4>Grupos</h4>
  <table id="grupos"><thead><tr><th>ID</th><th>Nome</th></tr></thead><tbody></tbody></table>
</div>

<div class="card" style="margin-top:12px">
  <h3>Lan√ßar pontos</h3>
  <label>Tipo</label>
  <select id="tipo"><option value="aluno">‚≠ê Estrelas (Aluno)</option><option value="grupo">üíé Diamantes (Grupo)</option></select>
  <label>ID selecionado (aluno_id ou grupo_id)</label><input id="targetId" placeholder="ex.: 12">
  <label>School ID</label><input id="school" placeholder="ALPHA">
  <label>ID Turma</label><input id="turma" placeholder="6A">
  <label>Quantidade (usar n√∫mero negativo para remover)</label><input id="qtd" type="number" value="1">
  <label>Motivo</label><input id="motivo" placeholder="Participa√ß√£o">
  <button id="lan√ßar" style="margin-top:8px">Lan√ßar</button>
  <div id="msg" style="color:#666;margin-top:6px"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.1";
let supa=null; const el=id=>document.getElementById(id); const tb=id=>document.querySelector(`#${id} tbody`);
function mk(){ const url=el('url').value.trim(), anon=el('anon').value.trim(); if(!url||!anon){alert('Informe URL e ANON');return null;} return createClient(url, anon, {auth:{persistSession:true}}); }
async function who(){ const { data:{ user } }=await supa.auth.getUser(); el('me').textContent=user?`Logado: ${user.email}`:'N√£o logado'; }

el('login').onclick = async ()=>{ supa=mk(); if(!supa) return;
  const { error } = await supa.auth.signInWithPassword({ email: el('email').value.trim(), password: el('pwd').value.trim() });
  if(error){ alert(error.message); return; }
  await who();
  const { data, error:err } = await supa.from('v2.professores').select('id_escola,id_turma').order('id_escola').order('id_turma');
  if(err){ alert(err.message); return; }
  el('turmas').innerHTML = (data||[]).map(r=>`<option value="${r.id_escola}::${r.id_turma}">${r.id_escola} ‚Ä¢ ${r.id_turma}</option>`).join('');
};

el('loadAlunos').onclick = async ()=> {
  const sel = el('turmas').value.split('::'); const sch=sel[0], t=sel[1];
  const { data, error } = await supa.from('v2.alunos').select('id_aluno,nome_aluno').eq('school_id',sch).eq('id_turma',t).order('id_aluno');
  if(error){ alert(error.message); return; }
  tb('alunos').innerHTML = (data||[]).map(r=>`<tr><td>${r.id_aluno}</td><td>${r.nome_aluno}</td></tr>`).join('');
  el('school').value=sch; el('turma').value=t;
};

el('loadGrupos').onclick = async ()=> {
  const sel = el('turmas').value.split('::'); const sch=sel[0], t=sel[1];
  const { data, error } = await supa.from('v2.grupos').select('id_grupo,nome_grupo').eq('school_id',sch).eq('id_turma',t).order('id_grupo');
  if(error){ alert(error.message); return; }
  tb('grupos').innerHTML = (data||[]).map(r=>`<tr><td>${r.id_grupo}</td><td>${r.nome_grupo}</td></tr>`).join('');
  el('school').value=sch; el('turma').value=t;
};

el('lan√ßar').onclick = async ()=> {
  const tipo=el('tipo').value, id=parseInt(el('targetId').value,10), sch=el('school').value.trim(), t=el('turma').value.trim();
  const qtd=parseInt(el('qtd').value,10)||0, mot=el('motivo').value.trim();
  if(!id||!sch||!t||!qtd) return alert('Preencha tudo');
  if(tipo==='aluno'){
    const { error } = await supa.from('v2.pontos_alunos').insert({ id_aluno:id, school_id:sch, id_turma:t, quantidade:qtd, motivo:mot, created_by:(await supa.auth.getUser()).data.user.id });
    document.getElementById('msg').textContent = error ? ('Erro: '+error.message) : 'OK (aluno)';
  } else {
    const { error } = await supa.from('v2.pontos_grupos').insert({ id_grupo:id, school_id:sch, id_turma:t, quantidade:qtd, motivo:mot, created_by:(await supa.auth.getUser()).data.user.id });
    document.getElementById('msg').textContent = error ? ('Erro: '+error.message) : 'OK (grupo)';
  }
};
</script>
</html>
