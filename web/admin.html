<!doctype html><html lang="pt-br"><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gameficando • Admin</title>
<style>body{font-family:system-ui,Arial;margin:20px} .row{display:flex;gap:20px;flex-wrap:wrap}
.card{border:1px solid #ddd;border-radius:12px;padding:12px;min-width:320px} label{font-size:12px;color:#666}
input,select,button{padding:8px;font-size:14px} input,select{width:100%} table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #eee;padding:6px;text-align:left} button{cursor:pointer}</style>
<h1>Gameficando • Admin</h1>

<div class="card">
  <h3>Conexão & Login</h3>
  <label>SUPABASE_URL</label><input id="url" placeholder="https://xxxx.supabase.co">
  <label>ANON KEY</label><input id="anon" placeholder="eyJ...">
  <label>Email</label><input id="email" placeholder="seu@dominio.com">
  <label>Senha</label><input id="pwd" type="password" placeholder="********">
  <div style="margin-top:8px"><button id="login">Entrar</button> <span id="me" style="margin-left:8px;color:#666"></span></div>
</div>

<div class="row" style="margin-top:12px">
  <div class="card">
    <h3>Escolas</h3>
    <label>ID</label><input id="esc-id" placeholder="ALPHA">
    <label>Nome</label><input id="esc-nome" placeholder="Escola Alpha">
    <button id="esc-add" style="margin-top:6px">Criar Escola</button>
    <table id="esc-tbl"><thead><tr><th>ID</th><th>Nome</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card">
    <h3>Turmas</h3>
    <label>School ID</label><input id="t-school" placeholder="ALPHA">
    <label>ID Turma</label><input id="t-id" placeholder="6A">
    <label>Nome Turma</label><input id="t-nome" placeholder="6º A">
    <button id="t-add" style="margin-top:6px">Criar Turma</button>
    <table id="t-tbl"><thead><tr><th>Turma</th><th>Nome</th><th>Escola</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card">
    <h3>Alunos</h3>
    <label>School ID</label><input id="a-school" placeholder="ALPHA">
    <label>ID Turma</label><input id="a-turma" placeholder="6A">
    <label>Nome Aluno</label><input id="a-nome" placeholder="João Silva">
    <button id="a-add" style="margin-top:6px">Criar Aluno</button>
    <table id="a-tbl"><thead><tr><th>ID</th><th>Nome</th><th>Turma</th><th>Escola</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<div class="card" style="margin-top:12px">
  <h3>Criar Usuário (opcional)</h3>
  <div style="color:#666">Requer função <code>/create-user</code> publicada. Apenas <b>MASTER</b> consegue.</div>
  <label>Email</label><input id="u-email" placeholder="prof.jose@alpha.com">
  <label>Senha</label><input id="u-pass" type="password" placeholder="SenhaForte!123">
  <label>Role</label><select id="u-role"><option>SCHOOL_ADMIN</option><option>TEACHER</option></select>
  <label>School ID</label><input id="u-school" placeholder="ALPHA">
  <label>Turmas (se professor, separadas por vírgula)</label><input id="u-turmas" placeholder="6A,6B">
  <button id="u-create" style="margin-top:6px">Criar Usuário</button>
  <div id="u-msg" style="color:#666;margin-top:6px"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.1";
let supa=null; let session=null;
const el=id=>document.getElementById(id); const tb=(id)=>document.querySelector(`#${id} tbody`);
function mk(){ const url=el('url').value.trim(), anon=el('anon').value.trim(); if(!url||!anon){alert('Informe URL e ANON');return null;} return createClient(url, anon, {auth:{persistSession:true}}); }
async function who(){ const { data:{ user } }=await supa.auth.getUser(); session=user; el('me').textContent=user?`Logado: ${user.email}`:'Não logado'; }
async function listEscolas(){ const {data,error}=await supa.from('v2.escolas').select('id_escola,nome_escola').order('id_escola'); if(error){alert(error.message);return} tb('esc-tbl').innerHTML=(data||[]).map(r=>`<tr><td>${r.id_escola}</td><td>${r.nome_escola}</td></tr>`).join(''); }
async function listTurmas(){ const {data,error}=await supa.from('v2.turmas').select('id_turma,nome_turma,school_id').order('school_id').order('id_turma'); if(error){alert(error.message);return} tb('t-tbl').innerHTML=(data||[]).map(r=>`<tr><td>${r.id_turma}</td><td>${r.nome_turma}</td><td>${r.school_id}</td></tr>`).join(''); }
async function listAlunos(){ const {data,error}=await supa.from('v2.alunos').select('id_aluno,nome_aluno,id_turma,school_id').order('school_id').order('id_turma').order('id_aluno'); if(error){alert(error.message);return} tb('a-tbl').innerHTML=(data||[]).map(r=>`<tr><td>${r.id_aluno}</td><td>${r.nome_aluno}</td><td>${r.id_turma}</td><td>${r.school_id}</td></tr>`).join(''); }

el('login').onclick = async ()=>{ supa=mk(); if(!supa) return;
  const { error } = await supa.auth.signInWithPassword({ email: el('email').value.trim(), password: el('pwd').value.trim() });
  if(error){ alert(error.message); return; }
  await who(); await listEscolas(); await listTurmas(); await listAlunos();
};

el('esc-add').onclick = async ()=>{ const id=el('esc-id').value.trim(), nome=el('esc-nome').value.trim(); if(!id||!nome) return alert('Preencha ID/Nome');
  const { error } = await supa.from('v2.escolas').insert({ id_escola:id, nome_escola:nome }); if(error) return alert(error.message); await listEscolas();
};

el('t-add').onclick = async ()=>{ const s=el('t-school').value.trim(), id=el('t-id').value.trim(), n=el('t-nome').value.trim(); if(!s||!id||!n) return alert('Preencha escola/turma/nome');
  const { error } = await supa.from('v2.turmas').insert({ school_id:s, id_turma:id, nome_turma:n }); if(error) return alert(error.message); await listTurmas();
};

el('a-add').onclick = async ()=>{ const s=el('a-school').value.trim(), t=el('a-turma').value.trim(), n=el('a-nome').value.trim(); if(!s||!t||!n) return alert('Preencha escola/turma/nome');
  const { error } = await supa.from('v2.alunos').insert({ school_id:s, id_turma:t, nome_aluno:n }); if(error) return alert(error.message); await listAlunos();
};

el('u-create').onclick = async ()=> {
  const base = el('url').value.trim();
  const { data:{ session } } = await supa.auth.getSession();
  const email=el('u-email').value.trim(), password=el('u-pass').value.trim(), role=el('u-role').value, school_id=el('u-school').value.trim();
  const turmas = el('u-turmas').value.trim().split(',').map(s=>s.trim()).filter(Boolean);
  const resp = await fetch(`${base}/functions/v1/create-user`, { method:'POST',
    headers:{ 'Authorization':`Bearer ${session?.access_token||''}`, 'Content-Type':'application/json' },
    body: JSON.stringify({ email,password,role,school_id,turmas })
  });
  const out = await resp.json().catch(()=> ({}));
  document.getElementById('u-msg').textContent = resp.ok ? `Criado: ${out.user_id}` : `Erro: ${out?.message||resp.statusText}`;
};
</script>
</html>
